---
title: 'Experiment 3: partial local search'
author: "Samuel Udelman"
date: "September 2, 2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
```

```{r message=FALSE, warning=FALSE}
library(ggplot2)
library(dplyr)
library(readr)
library(tidyr)

# Colors
ggColor <- function(n) {
  hues = seq(15, 375, length = n + 1)
  hcl(h = hues, l = 65, c = 100)[1:n]
}

```

## Objective

it is possible to perform a local search to a partial schedule as a way to increase the chances to get a better one built. This experiment aims to assess the impact on applying partial local search at different times during the construction process on the schedule quality.

## Parameters
The following list summarizes the condition of relevant parameters:

1. Partial local search for several frequencies: 
  - 30% & 60%
  - 40% & 80%
  - only 50%
  - only 80%
  - control: no partial local search
2. Run for 1000 iterations
3. Fix alpha = 0.5
4. For JSPTWT use WEDD dispatch rule
5. Due date factor 1.3
6. Quality coefficient set to Inf

## Results

### JSP

```{r message=FALSE, warning=FALSE}
# Function to substitute whitespaces in csv files
CleanCSV <- function(file) {
  lines <- readLines(file)
  
  # Remove extra column names
  remove <- which(grepl("objective", lines))
  if (length(remove) > 1) {
    lines <- lines[-remove[-1]]
  }
  
  # Remove local search data
  lines <- lines[which(!grepl("cet", lines))]
  
  # Replace whitespaces
  cleanLines <- gsub(" ", "-", lines, fixed = TRUE)
  
  textfile <- textConnection(cleanLines)
  table <- read.csv2(textfile, sep = ",")
  
  return(table)
}

# Load data
dir <- "../results/experiment3/jsp"
df <- list.files(path=dir, pattern="*.csv", full.names = TRUE) %>% 
  lapply(CleanCSV) %>% 
  bind_rows 

# Include instance sizes and best values
bests <- c(666, 655, 597, 590, 593,
           926, 890, 863, 951, 958,
           1222, 1039, 1150, 1292, 1207,
           945, 784, 848, 842, 902,
           1046, 927, 1032, 935, 977,
           1218, 1235, 1216, 1152, 1355,
           1784, 1850, 1719, 1721, 1888,
           1268, 1397, 1196, 1233, 1222)

sizes <- c(rep("10x5", 5), rep("15x5", 5), rep("20x5", 5),
           rep("10x10", 5), rep("15x10", 5), rep("20x10", 5),
           rep("30x10", 5), rep("15x15", 5))

df <- df %>% filter(!is.na(globalIter)) %>% 
  select(objective, globalIter, instance, plsCase) %>%
  mutate(best = bests[as.numeric(gsub("[^0-9.]", "", instance))], 
         size = sizes[as.numeric(gsub("[^0-9.]", "", instance))],
         normObjective = objective/best)
```

```{r fig1, fig.cap="Distribution of normalized objective values per case", warning=FALSE}
# Objective boxplot
p <- ggplot(df, aes(y = normObjective, x = size , fill = plsCase)) + 
  geom_hline(yintercept = 1, linetype="dashed") +
  geom_boxplot() +
  theme_bw()              # for clean look overall
p
```


### JSPTWT

```{r message=FALSE, warning=FALSE}
# Load data
dir <- "../results/experiment3/jsptwt"
df <- list.files(path=dir, pattern="*.csv", full.names = TRUE) %>% 
  lapply(CleanCSV) %>% 
  bind_rows 

# Include instance sizes and best values
bests <- c(2299, 1762, 1951, 1917, 1878,
           5810, 5765, 5475, 5608, 6618,
           11978, 10542, 11557, 13107, 12330,
           1169, 899, 929, 948, 805, 
           3560, 4227, 3777, 3539, 3313,
           8946, 9090, 9091, 8744, 8626,
           27671, 30301, 25902, 27901, 29652,
           2957, 2290, 2122, 1676, 2078)

df <- df %>% filter(!is.na(globalIter)) %>% 
  select(objective, globalIter, instance, plsCase) %>%
  mutate(best = bests[as.numeric(gsub("[^0-9.]", "", instance))], 
         size = sizes[as.numeric(gsub("[^0-9.]", "", instance))],
         normObjective = as.numeric(objective)/best)
```

```{r fig5, fig.cap="JSPTWT Distribution of normalized objective values per operator", warning=FALSE}
# Objective boxplot
p <- ggplot(df, aes(y = normObjective, x = size , fill = plsCase)) + 
  geom_hline(yintercept = 1, linetype="dashed") +
  geom_boxplot() +
  theme_bw()              # for clean look overall
p
```